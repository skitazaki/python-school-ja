<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>データの管理 &mdash; Python School 2.0.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Python School 2.0.0 documentation" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Python School 2.0.0 documentation</span></a></h1>
        <h2 class="heading"><span>データの管理</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="id1">
<h1>データの管理<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p><tt class="file docutils literal"><span class="pre">manage.py</span></tt> を使ってデータを管理できます。
<tt class="file docutils literal"><span class="pre">manage.py</span></tt> の次の３つのコマンドを使ってみましょう。</p>
<ul>
<li><dl class="first docutils">
<dt>dumpdata:</dt>
<dd><p class="first last">データをバックアップします</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>loaddata:</dt>
<dd><p class="first last">バックアップデータを復元します</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>shell:</dt>
<dd><p class="first last">コマンドラインで操作できます</p>
</dd>
</dl>
</li>
</ul>
<div class="section" id="id2">
<h2>データをバックアップする<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>virtualenv 環境を有効にしてから、次のコマンドを実行してみましょう。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python manage.py dumpdata
</pre></div>
</div>
<p>ターミナルに大量のデータが出力されるでしょう。
これはデータベースの内容を JSON 形式に書き出したものになります。
ファイルに書き出して、JSON のビューアー (例: <a class="reference external" href="http://jsonviewer.codeplex.com/">JSON Viewer</a>) で見てみましょう。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python manage.py dumpdata &gt;dumpdata.json
</pre></div>
</div>
<div class="figure">
<img alt="../images/django-dumpdata.png" src="../images/django-dumpdata.png" />
</div>
<p>たくさんあるデータの中に、 <em>logviewer.changeset</em> があります。</p>
<p>すべてのデータをバックアップできることは便利ですが、
開発を進めていく中では冗長でもあります。
<em>dumpdata</em> コマンドは引数を受け取ることができ、アプリケーション名を渡すと、
そのアプリケーションのデータだけを出力できます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python manage.py dumpdata logviewer &gt;logviewer.json
</pre></div>
</div>
<div class="figure">
<img alt="../images/django-dumpdata-app-only.png" src="../images/django-dumpdata-app-only.png" />
</div>
<p>アプリケーションのモデルごとでも出力できます。
<em>dumpdata</em> コマンドに渡す引数を <em>logviewer</em> から <em>logviewer.changeset</em> に変更してみてください。</p>
</div>
<div class="section" id="id3">
<h2>バックアップデータを復元する<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p><em>dumpdata</em> コマンドで出力した JSON データは、 <em>loaddata</em> コマンドで取り込めます。</p>
<p>データベースファイルを一度退避して、データベースの作成からやり直してみましょう。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; move sandbox.sqlite sandbox-backup.sqlite
&gt; python manage.py syncdb
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">作り直すときは、スーパーユーザーを作成しなくて良いので、
<cite>Would you like to create one now? (yes/no):</cite> という質問には <em>no</em> と答えましょう。</p>
</div>
<p>先程バックアップしたすべてのデータファイルを引数に渡します。
結果として、いくつのオブジェクトを復元できたかを表示してくれます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python manage.py loaddata dumpdata.json
Installed 41 object(s) from 1 fixture(s)
</pre></div>
</div>
<p>もちろん、アプリケーションごと、アプリケーションのモデルごとにも復元できます。
<em>dumpdata</em> コマンドで出力した JSON にはモデルの情報も含まれていますので、
引数のファイル名を変更してみてください。
また、引数のファイル名は複数指定できます。</p>
<p>データを復元できる、ということは、テストデータの共有につながります。
マスタデータを JSON で保存しておくことで、チーム開発におけるデータ入力の手間を省けます。</p>
</div>
<div class="section" id="id4">
<h2>コマンドラインで操作する<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>モデルデータは Python オブジェクトとして定義されていますから、
Python のインタラクティブシェルからも操作できます。
ただし、モジュール検索パスを調整したり、設定情報を読み込む必要があります。</p>
<p><tt class="file docutils literal"><span class="pre">manage.py</span></tt> の <em>shell</em> コマンドは、これらをラップしてくれます。
実際に試してみましょう。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python manage.py shell
</pre></div>
</div>
<p>通常の Python プロンプトと同様ですが、アプリケーションをインポートできます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">logviewer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logviewer</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Changeset</span>
<span class="go">&lt;class &#39;logviewer.models.Changeset&#39;&gt;</span>
</pre></div>
</div>
<p>Django のモデル API に関しては公式のドキュメントとチュートリアルを参照してください。
参考までに、新規オブジェクトを作成し、オブジェクトの一覧を表示してみます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">logviewer</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Changeset</span><span class="p">(</span><span class="n">revision</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">committer</span><span class="o">=</span><span class="s">&quot;Django&quot;</span><span class="p">,</span> <span class="n">commit_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">id</span>
<span class="go">2</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logviewer</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Changeset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;Changeset: Changeset object&gt;, &lt;Changeset: Changeset object&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">changesets</span> <span class="o">=</span> <span class="n">_</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">changeset</span> <span class="ow">in</span> <span class="n">changesets</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">changeset</span><span class="o">.</span><span class="n">committer</span>
<span class="gp">...</span>
<span class="go">shigeru-kitazaki</span>
<span class="go">Django</span>
</pre></div>
</div>
<p>簡単に動作を確認したい場合には、コマンドラインで操作してみてください。</p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2014, KITAZAKI Shigeru.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>