<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Web ブラウザに表示 &mdash; Python School 2.0.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Python School 2.0.0 documentation" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Python School 2.0.0 documentation</span></a></h1>
        <h2 class="heading"><span>Web ブラウザに表示</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="web">
<h1>Web ブラウザに表示<a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h1>
<p>ここまでは裏側の設定に終始してきました。
ここでは、HTTP のリクエストを受け取り、レスポンスを返す流れを学習します。</p>
<div class="section" id="id1">
<h2>トップページを表示する<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>ブラウザからどのようにしてアプリケーションにアクセスできると嬉しいでしょうか？
トップページの URL は？ データの一覧を表示する URL は？ 設定を変更する URL は？</p>
<p>これらの情報は <tt class="file docutils literal"><span class="pre">urls.py</span></tt> に記載します。
たとえば、 <a class="reference external" href="http://localhost:8000/logviewer">http://localhost:8000/logviewer</a> でトップページを表示するためには、
次のように記述します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls.defaults</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>

<span class="c"># Uncomment the next two lines to enable the admin:</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="c"># Examples:</span>
    <span class="c"># url(r&#39;^$&#39;, &#39;sandbox.views.home&#39;, name=&#39;home&#39;),</span>
    <span class="c"># url(r&#39;^sandbox/&#39;, include(&#39;sandbox.foo.urls&#39;)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^logviewer$&#39;</span><span class="p">,</span> <span class="s">&#39;logviewer.views.home&#39;</span><span class="p">),</span>  <span class="c"># &lt;-- ここを追加</span>

    <span class="c"># Uncomment the admin/doc line below to enable admin documentation:</span>
    <span class="c"># url(r&#39;^admin/doc/&#39;, include(&#39;django.contrib.admindocs.urls&#39;)),</span>

    <span class="c"># Uncomment the next line to enable the admin:</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>次に、 <tt class="file docutils literal"><span class="pre">logviewer/views.py</span></tt> に次のように記述します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Hello, world.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>そして、  <tt class="file docutils literal"><span class="pre">manage.py</span></tt> で <em>runserver</em> を実行します。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python manage.py runserver
Validating models...

0 errors found
Django version 1.3, using settings &#39;sandbox.settings&#39;
Development server is running at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
</pre></div>
</div>
<p><a class="reference external" href="http://localhost:8000/logviewer">http://localhost:8000/logviewer</a> にアクセスすると、
&#8220;Hello, world.&#8221; という文字列が表示されます。</p>
<p><tt class="file docutils literal"><span class="pre">logviewer.views.py</span></tt> で定義する関数の戻り値が HTTP のレスポンスになり、
<tt class="docutils literal"><span class="pre">HttpResponse</span></tt> に与える文字列が表示されることを確認しました。</p>
<div class="section" id="html">
<h3>HTML を表示する<a class="headerlink" href="#html" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">HttpResponse</span></tt> に文字列として HTML を渡すと、表示されるページは HTML になります。
<tt class="docutils literal"><span class="pre">home()</span></tt> 関数を次のように修正してみましょう。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;html&gt;</span>
<span class="s">        &lt;head&gt;&lt;title&gt;SVN Log Viewer&lt;/title&gt;&lt;/head&gt;</span>
<span class="s">        &lt;body&gt;&lt;h1&gt;Hello, world.&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>ブラウザの画面を再読み込みすると、変更が反映されるはずです。</p>
<p>しかし、このまま HTML を書き進めていくと、ソースの記述が大変です。
Python のソースコードの中に HTML を記述するため、
全体として非常に見通しが悪くなってしまいます。</p>
<p>そこで、HTML の記述は外部ファイルに分離します。</p>
</div>
</div>
<div class="section" id="id2">
<h2>テンプレートファイルを使う<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Django はテンプレートエンジンも持っています。
まずは <tt class="file docutils literal"><span class="pre">settings.py</span></tt> で <tt class="docutils literal"><span class="pre">TEMPLATE_DIRS</span></tt> にテンプレートのパスを設定します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c"># Put strings here, like &quot;/home/html/django_templates&quot; or &quot;C:/www/django/templates&quot;.</span>
    <span class="c"># Always use forward slashes, even on Windows.</span>
    <span class="c"># Don&#39;t forget to use absolute paths, not relative paths.</span>
    <span class="s">&quot;D:/sandbox/webapp-tools/sandbox/templates&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>英語のコメントでも説明されていますが、Windows でもパス区切り文字にはスラッシュを使います。</p>
<p>次に、テンプレートディレクトリ (ここでは <tt class="docutils literal"><span class="pre">&quot;D:/sandbox/webapp-tools/sandbox/templates&quot;</span></tt> とします) を作成し、 <tt class="file docutils literal"><span class="pre">index.html</span></tt> を置きます。</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>SVN Log Viewer<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello, world.<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>このテンプレートファイルを読み込むように、 <tt class="file docutils literal"><span class="pre">logviewer/views.py</span></tt> を編集します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">loader</span>


<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="id3">
<h3>パラメータを与える<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>表示を動的に変更するために、テンプレートエンジンにパラメータを与えることもできます。
まず、テンプレートファイル (<tt class="file docutils literal"><span class="pre">index.html</span></tt>) を次のように書き換えます。</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>SVN Log Viewer<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello, world.<span class="nt">&lt;/h1&gt;</span>
    <span class="c">&lt;!-- ユーザー名を動的に表示させる。 --&gt;</span>
    <span class="nt">&lt;p&gt;</span>{{ username }}<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">うまく表示できない場合は、テンプレートファイルのエンコーディングが UTF-8 であることを確認してください。</p>
</div>
<p>次に、 <tt class="file docutils literal"><span class="pre">logviewer/views.py</span></tt> でコンテキスト (<tt class="docutils literal"><span class="pre">Context</span></tt>) にパラメータを設定します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">loader</span>


<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&quot;shigeru-kitazaki&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<p>コンテキストパラメータには単なる文字列だけでなく、オブジェクトやリスト、Django のモデルなども渡すことが可能です。</p>
</div>
</div>
<div class="section" id="id4">
<h2>モデルオブジェクトを渡す<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>データベースから検索した結果をコンテキストパラメータに設定することで、簡単にモデルとビューを接続できます。</p>
<p>モデルの API を使って ID が「1」であるオブジェクトを取得し、
テンプレートエンジンに渡してみます。</p>
<p>テンプレートファイル (<tt class="file docutils literal"><span class="pre">index.html</span></tt>) を次のように書き換えます。</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>SVN Log Viewer<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Changeset ID=1<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>リビジョン: {{ changeset.revision }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>コミッター: {{ changeset.committer }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>日付: {{ changeset.commit_date }}<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p><tt class="file docutils literal"><span class="pre">logviewer/views.py</span></tt> は次のようになります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">loader</span>
<span class="kn">from</span> <span class="nn">logviewer.models</span> <span class="kn">import</span> <span class="n">Changeset</span>


<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">changeset</span> <span class="o">=</span> <span class="n">Changeset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span><span class="s">&#39;changeset&#39;</span><span class="p">:</span> <span class="n">changeset</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<p>Webブラウザに表示させると、以下のようになるでしょう。</p>
<img alt="../images/django-mvc.png" src="../images/django-mvc.png" />
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2014, KITAZAKI Shigeru.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>