<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ネットワークプログラミング &mdash; Python School 1.5.2 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.5.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Python School 1.5.2 documentation" href="../index.html" />
    <link rel="up" title="発展的なことがら" href="index.html" />
    <link rel="next" title="Web API" href="advanced-4.html" />
    <link rel="prev" title="モジュールのインポート方法いろいろ" href="advanced-2.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Python School 1.5.2 documentation</span></a></h1>
        <h2 class="heading"><span>ネットワークプログラミング</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="advanced-2.html">モジュールのインポート方法いろいろ</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advanced-4.html">Web API</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="id1">
<h1>ネットワークプログラミング<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>簡単なネットワークプログラミングを行います。</p>
<div class="section" id="http">
<h2>HTTP でダウンロード<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h2>
<p>標準ライブラリの <cite>urllib</cite> を使います。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.python.org/library/urllib.html">20.5. urllib — Open arbitrary resources by URL</a> - (公式ドキュメント)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>似た名称のライブラリとして <cite>httplib</cite> があります。これは使いません。</p>
<p><a class="reference external" href="http://www.python.jp/doc/2.4/lib/module-httplib.html">httplib &#8211; HTTP プロトコルクライアント</a></p>
<blockquote class="last">
<div>通常、このモジュールは直接使いません</div></blockquote>
</div>
<p>引数で渡された URL のコンテンツをダウンロードする処理は次のように記述できます。</p>
<p><tt class="file docutils literal"><span class="pre">downloader.py</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;%prog url [, url [, ... ]]</span>

<span class="sd">Download contents from given URL list.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="c"># Check the document about version differences.</span>
<span class="c"># http://docs.python.org/library/urlparse.html#urlparse.parse_qs</span>
<span class="c">#     New in version 2.6: Copied from the cgi module.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">parse_qs</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cgi</span> <span class="kn">import</span> <span class="n">parse_qs</span>

<span class="kn">from</span> <span class="nn">pyschool.cmdline</span> <span class="kn">import</span> <span class="n">parse_args</span>


<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="c"># Check the document for return value attributes.</span>
    <span class="c"># http://docs.python.org/library/urlparse.html#urlparse.urlparse</span>
    <span class="c"># &quot;index 2&quot; means &quot;path&quot; attribute, Hierarchical path.</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> already exists, overwrite it.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Download: </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="c"># Dirty code. This replacement should be in `parse_args()`.</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;%prog&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="c"># vim: set et ts=4 sw=4 cindent fileencoding=utf-8 :</span>
</pre></div>
</div>
<p>Linux などの場合は <strong class="command">wget</strong> や <strong class="command">curl</strong> で十分ですが、
Windows 環境でバッチ処理でダウンロードさせたい場合には便利でしょう。</p>
<p>実行結果</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; python downloader.py &quot;http://chart.googleapis.com/chart?chs=250x100&amp;chd=t:60,40&amp;cht=p3&amp;chl=Hello|World&quot;
&gt; move chart hello-world-chart.png
</pre></div>
</div>
<p><tt class="file docutils literal"><span class="pre">hello-world-chart.png</span></tt></p>
<div class="figure">
<img alt="../images/hello-world-chart.png" src="../images/hello-world-chart.png" />
</div>
</div>
<div class="section" id="id2">
<h2>HTTP のレスポンス処理<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>単にファイルに書き出すのではなく、読み込んだデータを加工することも多くあります。
大枠は上記のダウンロードスクリプトと同じですが、
追加で標準ライブラリの <cite>urllib2</cite> も使います。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.python.org/library/urllib2.html">20.6. urllib2 — extensible library for opening URLs</a></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">標準ライブラリには <tt class="docutils literal"><span class="pre">urllib</span></tt> と <tt class="docutils literal"><span class="pre">urllib2</span></tt> があります。
モジュール名に数字が付いていたり、Python 3 系では統合されていたり、
この辺りの経緯はややこしいので、Python に詳しい人に口頭で確認してください。
このため、ブログ記事などは参照するときは、Python のどのバージョンを対象にしているかを <em>必ず</em> 確認してください。</p>
</div>
<p>Google の API から天気予報を取得します。
結果は XML で返ってきますので、それを解析して表示させます。</p>
<p><tt class="file docutils literal"><span class="pre">http-request-sample.py</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;Download weather forecast around Tokyo.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="kn">import</span> <span class="n">parse</span>

<span class="n">API</span> <span class="o">=</span> <span class="s">&quot;http://www.google.com/ig/api?weather=Tokyo&quot;</span>


<span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Request URL: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s">&#39;?&#39;</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s">&quot;=&quot;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Response Header: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">URLError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">API</span><span class="p">)</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;forecast_conditions&quot;</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">elems</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">),</span> <span class="n">elems</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> tag was not found.&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%5s</span><span class="se">\t</span><span class="si">%-20s</span><span class="se">\t</span><span class="si">%3s</span><span class="se">\t</span><span class="si">%3s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;day_of_week&quot;</span><span class="p">),</span> <span class="n">data</span><span class="p">(</span><span class="s">&quot;condition&quot;</span><span class="p">),</span>
                                    <span class="n">data</span><span class="p">(</span><span class="s">&quot;low&quot;</span><span class="p">),</span> <span class="n">data</span><span class="p">(</span><span class="s">&quot;high&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="c"># vim: set et ts=4 sw=4 cindent fileencoding=utf-8 :</span>
</pre></div>
</div>
<p>実行結果</p>
<div class="highlight-python"><div class="highlight"><pre>$ python http-request-sample.py
  Thu   Clear                    30      43
  Fri   Mostly Sunny             30      43
  Sat   Mostly Sunny             28      41
  Sun   Mostly Sunny             28      37
</pre></div>
</div>
<p>曜日、天気予報、最低気温、最高気温が表示されます。
なお、気温は華氏です。</p>
<p><cite>urllib2</cite> を使うときは、環境変数 <em>http_proxy</em> でプロキシサーバを設定できます。
環境変数の確認方法は <a class="reference internal" href="../cmdline/cmdline-3.html"><em>設定情報を管理する</em></a> を参照してください。
環境変数の設定方法は OS によって異なりますので、そのお作法に従ってください。</p>
<p>プロキシは自前でも設定できます。
公式ドキュメントにサンプルコードが掲載されていますので、一通り眺めてみると良いでしょう。</p>
<p>通信部分を柔軟に扱えるようにしたサードパーティーライブラリもあります。
必要に応じて利用すると便利ですが、様々なマシンで動かすためにはモジュールのポータビリティに注意してください。</p>
<ul class="simple">
<li><a class="reference external" href="http://code.google.com/p/httplib2/">httplib2</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/requests">requests</a></li>
</ul>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="advanced-2.html">モジュールのインポート方法いろいろ</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advanced-4.html">Web API</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, KITAZAKI Shigeru.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>